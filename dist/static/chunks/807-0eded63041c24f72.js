"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[807],{9807:function(e,t,r){r.d(t,{r_:function(){return M},createCollection:function(){return O},wK:function(){return d},createExpense:function(){return N},pU:function(){return g},ED:function(){return F},createWorkOrder:function(){return b},deleteCollection:function(){return E},Kc:function(){return k},LA:function(){return c},deleteExpense:function(){return j},he:function(){return J},l8:function(){return v},$k:function(){return D},CV:function(){return p},OL:function(){return s},Es:function(){return T},getDailyTransactions:function(){return q},z2:function(){return n},S4:function(){return l},NJ:function(){return y},sE:function(){return _},a0:function(){return S},cp:function(){return z},IG:function(){return f},getStats:function(){return B},f1:function(){return h},_H:function(){return i},$f:function(){return w},p8:function(){return m},OQ:function(){return a},updateCollection:function(){return C},uG:function(){return u},updateExpense:function(){return Y},ck:function(){return R},updateWorkOrder:function(){return x},xl:function(){return I}});let a=(0,r(6070).createBrowserClient)("https://rzcumzfzurthasgptggd.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ6Y3VtemZ6dXJ0aGFzZ3B0Z2dkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxNDA5MzYsImV4cCI6MjA4MTcxNjkzNn0.NlyDKeMj-4xa7ZSt5wsyRdCOay8w2SAIA-ZTjIRkyHw"),n=async()=>{let[e,t,r]=await Promise.allSettled([a.from("collections").select("amount, date"),a.from("expenses").select("amount, date"),a.from("work_orders").select("price, date, status")]),n="fulfilled"!==e.status||e.value.error?[]:e.value.data,o="fulfilled"!==t.status||t.value.error?[]:t.value.data,i="fulfilled"!==r.status||r.value.error?[]:r.value.data,l=new Date,s=l.toISOString().split("T")[0],d=new Date(l.getFullYear(),l.getMonth(),1).toISOString().split("T")[0],c=new Date(l.getFullYear(),l.getMonth()+1,0).toISOString().split("T")[0],u=(e,t)=>e.reduce((e,r)=>{var a;return e+(null!==(a=r[t])&&void 0!==a?a:0)},0);u(n,"amount");let m=u(i,"price"),f=i.filter(e=>e.date>=s&&"onaylandı"===e.status).reduce((e,t)=>{var r;return e+(null!==(r=t.price)&&void 0!==r?r:0)},0),p=n.filter(e=>e.date>=d&&e.date<=c).reduce((e,t)=>{var r;return e+(null!==(r=t.amount)&&void 0!==r?r:0)},0),g=o.filter(e=>e.date>=d&&e.date<=c).reduce((e,t)=>{var r;return e+(null!==(r=t.amount)&&void 0!==r?r:0)},0);return{data:{totalIncome:p,totalExpense:g,totalWorkAmount:m,pendingCollection:f,netProfit:p-g},errors:{collections:"fulfilled"===e.status?e.value.error:"rejected"===e.status?e.reason:null,expenses:"fulfilled"===t.status?t.value.error:"rejected"===t.status?t.reason:null,work_orders:"fulfilled"===r.status?r.value.error:"rejected"===r.status?r.reason:null}}};function o(e){return e.toISOString().slice(0,10)}async function i(){var e;let t=new Date;t.setUTCHours(0,0,0,0);let r=new Date(t);r.setUTCDate(t.getUTCDate()+10);let n=o(t),i=o(r),l=await a.from("work_orders").select("date,work_order_assignments(personnel_id,personnel(id,full_name))").gte("date",n).lte("date",i).order("date",{ascending:!0});if(l.error)return{error:l.error};let s=null!==(e=l.data)&&void 0!==e?e:[],d={};for(let e of s){let t=(e.date||"").slice(0,10);d[t]||(d[t]=[]),d[t].push(e)}return{data:d}}async function l(e,t){let r=new Date(e,t,1),n=new Date(e,t+1,0),i=o(r),l=o(n),{data:s,error:d}=await a.from("work_orders").select("\n      id,\n      date,\n      description,\n      address,\n      price,\n      status,\n      customers (\n        name\n      ),\n      work_order_assignments (\n        personnel_id,\n        personnel (\n          id,\n          full_name,\n          role,\n          phone\n        )\n      )\n    ").gte("date",i).lte("date",l);if(d)throw d;if(!s)return{};let c={};return s.forEach(e=>{var t,r,a;let n=(e.date||"").slice(0,10);c[n]||(c[n]=[]);let o={id:e.id,customer:(null===(t=e.customers)||void 0===t?void 0:t.name)||"Bilinmeyen M\xfcşteri",status:"onaylandı"===e.status?"Onaylandı":"onaylanmadı"===e.status?"Onay Bekliyor":e.status,description:e.description,address:e.address,amount:e.price?"₺".concat(e.price.toLocaleString("tr-TR")):"₺0",staffCount:(null===(r=e.work_order_assignments)||void 0===r?void 0:r.length)||0,assignedStaff:(null===(a=e.work_order_assignments)||void 0===a?void 0:a.map(e=>{var t,r,a;return{name:(null===(t=e.personnel)||void 0===t?void 0:t.full_name)||"Silinmiş Personel",role:(null===(r=e.personnel)||void 0===r?void 0:r.role)||"-",phone:(null===(a=e.personnel)||void 0===a?void 0:a.phone)||"-"}}))||[]};c[n].push(o)}),c}let s=async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:20,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,o=a.from("customers").select("*",{count:"exact"});r&&(o=o.or("name.ilike.%".concat(r,"%,phone.ilike.%").concat(r,"%"))),n&&"T\xfcm\xfc"!==n&&(o=o.eq("type",n));let i=(e-1)*t,{data:l,error:s,count:d}=await o.order("name").range(i,i+t-1);if(s)throw s;return{data:l,count:d}},d=async e=>{let{data:t,error:r}=await a.from("customers").insert([{name:e.name,type:e.type,phone:e.phone,tax_id:e.taxId,address:e.address,description:e.description}]).select().single();if(r)throw r;return t},c=async e=>{let{error:t}=await a.from("customers").delete().eq("id",e);if(t)throw t;return!0},u=async(e,t)=>{let{data:r,error:n}=await a.from("customers").update({name:t.name,type:t.type,phone:t.phone,tax_id:t.taxId,address:t.address,description:t.description}).eq("id",e).select().single();if(n)throw n;return r},m=async(e,t)=>{if(!e&&!t)return[];let r=[];if(e){let n=a.from("customers").select("*").or("name.ilike.%".concat(e,"%,phone.ilike.%").concat(e,"%"));t&&(n=n.gte("created_at",t.start).lte("created_at",t.end));let{data:o}=await n;o&&r.push(...o.map(e=>({id:e.id,source:"M\xfcşteri",name:e.name,description:"Telefon: ".concat(e.phone||"-"," | Adres: ").concat(e.address||"-"),date:e.created_at?new Date(e.created_at).toLocaleDateString("tr-TR"):"-",amount:"-",extraInfo:"Tip: ".concat(e.type||"Normal"," | Bakiye: ₺").concat(e.current_balance||0)})))}let n=a.from("work_orders").select("*, customers(name)");if(e&&(n=n.ilike("description","%".concat(e,"%"))),t)n=n.gte("date",t.start).lte("date",t.end);else if(!e)return[];let{data:o}=await n.limit(50);o&&r.push(...o.map(e=>{var t;return{id:e.id,source:"İş Emri",name:(null===(t=e.customers)||void 0===t?void 0:t.name)||"Bilinmeyen M\xfcşteri",description:e.description||"A\xe7ıklama Yok",date:new Date(e.date).toLocaleDateString("tr-TR"),amount:"₺".concat(e.price||0),extraInfo:"Durum: ".concat("onaylandı"===e.status?"Onaylandı":"onaylanmadı"===e.status?"Bekliyor":e.status)}}));let i=a.from("collections").select("*, customers(name)");if(e&&(i=i.ilike("description","%".concat(e,"%"))),t&&(i=i.gte("date",t.start).lte("date",t.end)),!e&&!t)return[];let{data:l}=await i.limit(50);if(l&&r.push(...l.map(e=>{var t;return{id:e.id,source:"Tahsilat",name:(null===(t=e.customers)||void 0===t?void 0:t.name)||"Bilinmeyen M\xfcşteri",description:e.description||"Tahsilat",date:new Date(e.date).toLocaleDateString("tr-TR"),amount:"₺".concat(e.amount||0),extraInfo:"Y\xf6ntem: ".concat(e.payment_method||"-")}})),e){let{data:t}=await a.from("personnel").select("*").or("full_name.ilike.%".concat(e,"%,phone.ilike.%").concat(e,"%,role.ilike.%").concat(e,"%")).limit(20);t&&r.push(...t.map(e=>({id:e.id,source:"Personel",name:e.full_name,description:"Rol: ".concat(e.role||"-"," | Telefon: ").concat(e.phone||"-"),date:"-",amount:"Bakiye: ₺".concat(e.current_balance||0),extraInfo:"Durum: ".concat(e.status||"-")})))}let s=a.from("expenses").select("*");if(e&&(s=s.ilike("description","%".concat(e,"%"))),t&&(s=s.gte("date",t.start).lte("date",t.end)),e||t){let{data:e}=await s.limit(50);e&&r.push(...e.map(e=>({id:e.id,source:"Gider",name:"Gider Kaydı",description:e.description||"A\xe7ıklama Yok",date:new Date(e.date).toLocaleDateString("tr-TR"),amount:"₺".concat(e.amount||0),extraInfo:"Kategori: ".concat(e.category||"-")})))}return r},f=async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"year",t=new Date,r=new Date;"6months"===e?r.setMonth(t.getMonth()-6):"year"===e?r=new Date(t.getFullYear(),0,1):(r=new Date(t.getFullYear()-1,0,1),t.setFullYear(t.getFullYear()-1),t.setMonth(11),t.setDate(31));let n=r.toISOString().split("T")[0],o=t.toISOString().split("T")[0];try{let{data:e}=await a.from("collections").select("amount, date").gte("date",n).lte("date",o),{data:t}=await a.from("expenses").select("amount, date").gte("date",n).lte("date",o),{data:r}=await a.from("work_orders").select("id, date").gte("date",n).lte("date",o),i={},l=e=>e.substring(0,7);null==e||e.forEach(e=>{let t=l(e.date);i[t]||(i[t]={month:t,gelir:0,gider:0,kar:0}),i[t].gelir+=e.amount}),null==t||t.forEach(e=>{let t=l(e.date);i[t]||(i[t]={month:t,gelir:0,gider:0,kar:0}),i[t].gider+=e.amount}),Object.values(i).forEach(e=>{e.kar=e.gelir-e.gider});let s=Object.values(i).sort((e,t)=>e.month.localeCompare(t.month)).map(e=>({name:new Date(e.month+"-01").toLocaleDateString("tr-TR",{month:"short",year:"numeric"}),gelir:e.gelir,gider:e.gider,kar:e.kar})),d=l(new Date().toISOString()),c=i[d]||{gelir:0,gider:0,kar:0},u=(null==r?void 0:r.filter(e=>l(e.date)===d).length)||0;return{trendData:s,profitData:s.map(e=>({name:e.name,kar:e.kar})),summary:{income:c.gelir,expense:c.gider,profit:c.kar,jobs:u}}}catch(e){return console.error("Report stats error:",e),{trendData:[],profitData:[],summary:{income:0,expense:0,profit:0,jobs:0}}}},p=async()=>{try{let{data:e}=await a.from("customers").select("id, name");if(!e)return[];let{data:t}=await a.from("collections").select("customer_id, amount"),{data:r}=await a.from("work_orders").select("customer_id, amount, status");return e.map(e=>{let a=(null==t?void 0:t.filter(t=>t.customer_id===e.id))||[],n=(null==r?void 0:r.filter(t=>t.customer_id===e.id))||[],o=n.reduce((e,t)=>e+(t.amount||0),0),i=a.reduce((e,t)=>e+(t.amount||0),0),l=n.length;return{id:e.id,name:e.name,billed:o,collected:i,pending:Math.max(0,o-i),jobs:l,rate:o>0?i/o*100:0}}).sort((e,t)=>t.billed-e.billed).slice(0,30)}catch(e){return console.error("Customer performance error:",e),[]}},g=async e=>{let{data:t,error:r}=await a.from("personnel").insert([{full_name:e.name,phone:e.phone,tc_no:e.tc,status:e.status,role:"Personel"}]).select().single();if(r)throw r;return t},_=async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:20,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",n=a.from("personnel").select("*",{count:"exact"});r&&(n=n.or("full_name.ilike.%".concat(r,"%,phone.ilike.%").concat(r,"%")));let o=(e-1)*t,{data:i,error:l,count:s}=await n.order("full_name").range(o,o+t-1);if(l)throw l;return{data:i,count:s}},w=async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:20,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,o=a.from("work_orders").select("\n            *,\n            customers (\n                id,\n                name,\n                phone\n            ),\n            work_order_assignments (\n                personnel_id,\n                personnel (\n                    id,\n                    full_name\n                )\n            )\n        ",{count:"exact"});n&&(o=o.eq("date",n)),r&&(o=o.ilike("description","%".concat(r,"%")));let i=(e-1)*t,{data:l,error:s,count:d}=await o.order("date",{ascending:!1}).range(i,i+t-1);if(s)throw s;return{data:null==l?void 0:l.map(e=>{var t,r;let a=e.work_order_assignments||[],n=a.map(e=>e.personnel_id),o=a.map(e=>{var t;return null===(t=e.personnel)||void 0===t?void 0:t.full_name}).filter(Boolean);return{...e,customer:(null===(t=e.customers)||void 0===t?void 0:t.name)||"Bilinmiyor",customer_phone:(null===(r=e.customers)||void 0===r?void 0:r.phone)||"",personnel:o.length>0?o.join(", "):"Belirsiz",amount:e.price,customerObj:e.customers,assigned_staff:n}}),count:d}},h=async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:20,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"thisMonth",n=arguments.length>3?arguments[3]:void 0,o=n.start,i=n.end;if("thisMonth"===r){let e=new Date;o=new Date(e.getFullYear(),e.getMonth(),1).toISOString().split("T")[0],i=new Date(e.getFullYear(),e.getMonth()+1,0).toISOString().split("T")[0]}else"allTime"===r&&(o="2020-01-01",i="2099-12-31");let{data:l}=await a.from("collections").select("*").gte("date",o).lte("date",i).order("date",{ascending:!1}).limit(1e3),{data:s}=await a.from("expenses").select("*").gte("date",o).lte("date",i).order("date",{ascending:!1}).limit(1e3),d=[...(l||[]).map(e=>({...e,type:"income",category:"Tahsilat"})),...(s||[]).map(e=>({...e,type:"expense",method:"Nakit"}))].sort((e,t)=>new Date(t.date).getTime()-new Date(e.date).getTime()),c=(e-1)*t;return{data:d.slice(c,c+t),count:d.length}},y=async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:20,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",n=new Date().toISOString().split("T")[0],{data:o}=await a.from("work_orders").select("customer_id, price, date").gte("date",n).eq("status","onaylandı");if(!o||0===o.length)return{data:[],count:0};let i={},l=new Set;if(o.forEach(e=>{e.customer_id&&(i[e.customer_id]||(i[e.customer_id]={pending:0,lastDate:e.date}),i[e.customer_id].pending+=e.price||0,e.date<i[e.customer_id].lastDate&&(i[e.customer_id].lastDate=e.date),l.add(e.customer_id))}),0===l.size)return{data:[],count:0};let s=Array.from(l),d=a.from("customers").select("*").in("id",s);r&&(d=d.ilike("name","%".concat(r,"%")));let{data:c}=await d;if(!c)return{data:[],count:0};let u=c.map(e=>{let t=i[e.id];return{...e,pending:t.pending,lastTransactionDate:t.lastDate}}).sort((e,t)=>t.pending-e.pending),m=u.length,f=(e-1)*t;return{data:u.slice(f,f+t),count:m}},v=async()=>{let{data:e,error:t}=await a.from("crm_whatsapp").select("*").order("id",{ascending:!1});return t?(console.error("Error fetching CRM data:",t),[]):e},k=async e=>{let{error:t}=await a.from("crm_whatsapp").delete().eq("id",e);if(t)throw t},D=async e=>{let{data:t,error:r}=await a.from("customers").select("*").eq("id",e).single();if(r)throw r;let{data:n}=await a.from("collections").select("*").eq("customer_id",e),{data:o}=await a.from("work_orders").select("*").eq("customer_id",e),i=[...(n||[]).map(e=>({id:e.id,type:"collection",date:e.date,description:e.description||"Tahsilat",amount:e.amount,isPlus:!0})),...(o||[]).map(e=>({id:e.id,type:"work_order",date:e.date,description:e.description||"Hizmet Bedeli",amount:e.price,isPlus:!1}))].sort((e,t)=>new Date(t.date).getTime()-new Date(e.date).getTime()),l=(o||[]).reduce((e,t)=>e+(t.price||0),0),s=(n||[]).reduce((e,t)=>e+(t.amount||0),0);return{...t,history:i,current_balance:l-s}},S=async e=>{let{data:t,error:r}=await a.from("personnel").select("*").eq("id",e).single();if(r)throw r;let{data:n,error:o}=await a.from("work_order_assignments").select("\n            id,\n            work_order_id,\n            work_orders (\n                id,\n                date,\n                description,\n                address,\n                price\n            )\n        ").eq("personnel_id",e).order("created_at",{ascending:!1});o&&console.error("Jobs fetch error:",o);let i=(null==n?void 0:n.map(e=>e.work_orders).filter(Boolean))||[];i.sort((e,t)=>new Date(t.date).getTime()-new Date(e.date).getTime());let{data:l}=await a.from("payroll_records").select("*").eq("personnel_id",e).order("date",{ascending:!1}),s=(l||[]).reduce((e,t)=>e+(t.daily_wage||0),0),d=(l||[]).reduce((e,t)=>e+(t.paid_amount||0),0);return{...t,jobs:i,payroll:l||[],current_balance:s-d}},T=async function(e){var t,r,n,o,i,l,s,d,c;let u=arguments.length>1&&void 0!==arguments[1]&&arguments[1],[m,f,p,g]=await Promise.allSettled([a.from("personnel").select("id,full_name,role,status,current_balance").select("*").order("full_name",{ascending:!0}),a.from("payroll_records").select("id,personnel_id,daily_wage,paid_amount,description").eq("date",e),a.from("payroll_records").select("personnel_id,daily_wage,paid_amount").lt("date",e),a.from("work_orders").select("id,date,description,address,price,work_order_assignments(personnel_id,personnel(id,full_name)),customers(id,name)").eq("date",e).order("date",{ascending:!1})]),_="fulfilled"!==m.status||m.value.error?[]:m.value.data,w="fulfilled"!==f.status||f.value.error?[]:f.value.data,h="fulfilled"!==p.status||p.value.error?[]:p.value.data,y="fulfilled"!==g.status||g.value.error?[]:g.value.data,v=new Map;for(let e of h){let a=(null!==(t=e.daily_wage)&&void 0!==t?t:0)-(null!==(r=e.paid_amount)&&void 0!==r?r:0);v.set(e.personnel_id,(null!==(n=v.get(e.personnel_id))&&void 0!==n?n:0)+a)}let k=new Map;for(let e of w){let t=null!==(o=e.daily_wage)&&void 0!==o?o:0,r=null!==(i=e.paid_amount)&&void 0!==i?i:0,a=null!==(l=k.get(e.personnel_id))&&void 0!==l?l:{daily_wage:0,paid_amount:0};k.set(e.personnel_id,{daily_wage:a.daily_wage+t,paid_amount:a.paid_amount+r,recordId:e.id})}let D=new Map;for(let e of y)for(let t of null!==(s=e.work_order_assignments)&&void 0!==s?s:[]){let r=t.personnel_id||(null===(d=t.personnel)||void 0===d?void 0:d.id);if(!r)continue;let a=null!==(c=D.get(r))&&void 0!==c?c:[];a.push(e),D.set(r,a)}let S=_.map(e=>{var t,r,a;let n=null!==(t=v.get(e.id))&&void 0!==t?t:0,o=null!==(r=k.get(e.id))&&void 0!==r?r:{daily_wage:0,paid_amount:0},i=n+o.daily_wage-o.paid_amount,l=null!==(a=D.get(e.id))&&void 0!==a?a:[],s=l.map(e=>e.description).join(", ")||"-",d=e.full_name||e.name||"İsimsiz";return{personnel:e,carryover:n,daily_wage:o.daily_wage,paid_amount:o.paid_amount,balance_after:i,work_orders:l,id:e.id,name:d,phone:e.phone,job:s,devir:n,hakedis:o.daily_wage,odenen:o.paid_amount,bakiye:i,recordId:o.recordId}});return u&&(S=S.filter(e=>0!==e.balance_after)),S.sort((e,t)=>{let r="-"!==e.job,a="-"!==t.job;if(r&&!a)return -1;if(!r&&a)return 1;let n=0!==e.bakiye,o=0!==t.bakiye;return n&&!o?-1:!n&&o?1:(e.name||"").localeCompare(t.name||"")}),S};async function I(e){var t,r,n;let{personnel_id:o,date:i,daily_wage:l,paid_amount:s,description:d=null}=e,c=await a.from("payroll_records").select("id").eq("personnel_id",o).eq("date",i).maybeSingle();if(c.error&&"PGRST116"!==c.error.code)return{error:c.error};let u=null!==(r=null===(t=c.data)||void 0===t?void 0:t.id)&&void 0!==r?r:null;if(u){let e=await a.from("payroll_records").update({daily_wage:l,paid_amount:s,description:d}).eq("id",u).select("id").single();if(e.error)return{error:e.error}}else{let e=await a.from("payroll_records").insert([{personnel_id:o,date:i,daily_wage:l,paid_amount:s,description:d}]).select("id").single();if(e.error)return{error:e.error};u=e.data.id}let m=await a.from("payroll_records").select("daily_wage,paid_amount",{count:"exact",head:!1}).eq("personnel_id",o);if(m.error)return{id:u,balanceUpdated:!1,error:m.error};let f=(null!==(n=m.data)&&void 0!==n?n:[]).reduce((e,t)=>{var r,a;return e+(null!==(r=t.daily_wage)&&void 0!==r?r:0)-(null!==(a=t.paid_amount)&&void 0!==a?a:0)},0),p=await a.from("personnel").update({current_balance:f}).eq("id",o).select("id,current_balance").single();return p.error?{id:u,balanceUpdated:!1,error:p.error}:{id:u,balanceUpdated:!0,current_balance:p.data.current_balance}}let b=async e=>{let t=[e.date];if(e.is_recurring){console.log("Creating recurring order with params:",JSON.stringify(e,null,2));let r=new Date(e.date),a=new Date(e.date);if(e.recurring_end_date){let t=new Date(e.recurring_end_date);isNaN(t.getTime())?(console.warn("Invalid recurring_end_date provided, falling back to 3 months."),a.setMonth(a.getMonth()+3)):a=t}else a.setMonth(a.getMonth()+3);console.log("Calculated End Date:",a.toISOString());let n=new Date;if(n.setFullYear(n.getFullYear()+2),a>n&&(a=n),"once_month"===e.frequency)for(;r.setMonth(r.getMonth()+1),!(r>a);)t.push(r.toISOString().split("T")[0]);else if(["once_week","twice_week"].includes(e.frequency)){let r={Paz:0,Pzt:1,Sal:2,Çar:3,Per:4,Cum:5,Cmt:6},n=(e.recurring_days||[]).map(e=>r[e]),o=new Date(e.date);if(n.length>0)for(;o.setDate(o.getDate()+1),!(o>a);)n.includes(o.getDay())&&t.push(o.toISOString().split("T")[0]);else for(;o.setDate(o.getDate()+7),!(o>a);)t.push(o.toISOString().split("T")[0])}}let r=t.map((t,r)=>({customer_id:e.customer_id,date:t,description:e.description+(r>0?" (Tekrar)":""),address:e.address,price:e.price,personnel_count:e.personnel_count,status:"onaylanmadı"})),{data:n,error:o}=await a.from("work_orders").insert(r).select();if(o)throw o;if(e.assigned_staff&&Array.isArray(e.assigned_staff)&&e.assigned_staff.length>0){let t=n.flatMap(t=>e.assigned_staff.map(e=>({work_order_id:t.id,personnel_id:e}))),{error:r}=await a.from("work_order_assignments").insert(t);r&&console.error("Error creating assignments:",r)}return n},x=async(e,t)=>{console.log("updateWorkOrder called with:",e,t);let{data:r,error:n}=await a.from("work_orders").update({customer_id:t.customer_id,date:t.date,description:t.description,address:t.address,price:t.price,personnel_count:t.personnel_count}).eq("id",e).select().single();if(n)throw console.error("Supabase update error:",n),n;if(!r)throw Error("İş emri g\xfcncellenemedi (Kayıt bulunamadı?)");if(n)throw n;let{error:o}=await a.from("work_order_assignments").delete().eq("work_order_id",e);if(o&&console.error("Error deleting old assignments:",o),t.assigned_staff&&Array.isArray(t.assigned_staff)&&t.assigned_staff.length>0){let r=t.assigned_staff.map(t=>({work_order_id:e,personnel_id:t})),{error:n}=await a.from("work_order_assignments").insert(r);n&&console.error("Error saving new assignments:",n)}return r},M=async e=>{let{error:t}=await a.from("work_orders").update({status:"onaylandı"}).eq("id",e);if(t)throw t},q=async e=>{let{data:t,error:r}=await a.from("collections").select("*, customers(name)").eq("date",e).order("created_at",{ascending:!0});if(r)throw console.error("Collection error:",r),r;let{data:n,error:o}=await a.from("expenses").select("*").eq("date",e).order("created_at",{ascending:!0});if(o)throw console.error("Expense error:",o),o;let{data:i}=await a.from("payroll_records").select("paid_amount").eq("date",e),l=(i||[]).reduce((e,t)=>e+(t.paid_amount||0),0),{data:s}=await a.from("payroll_records").select("daily_wage, paid_amount"),d=(s||[]).reduce((e,t)=>e+((t.daily_wage||0)-(t.paid_amount||0)),0),{data:c,error:u}=await a.from("collections").select("amount").lt("date",e).in("payment_method",["nakit","Nakit","NAKİT","Cash","cash"]),{data:m,error:f}=await a.from("expenses").select("amount").lt("date",e).in("payment_method",["nakit","Nakit","NAKİT","Cash","cash"]),{data:p}=await a.from("payroll_records").select("paid_amount").lt("date",e),g=(null==c?void 0:c.reduce((e,t)=>e+(t.amount||0),0))||0;return{previousBalance:g-((null==m?void 0:m.reduce((e,t)=>e+(t.amount||0),0))||0)-((null==p?void 0:p.reduce((e,t)=>e+(t.paid_amount||0),0))||0),todayPaidWages:l,totalWageDebt:d,collections:t.map(e=>{var t;return{id:e.id,customer_id:e.customer_id,customer:(null===(t=e.customers)||void 0===t?void 0:t.name)||"Bilinmiyor",date:e.date,amount:e.amount,type:e.payment_method||"Nakit",payment_method:e.payment_method}}),expenses:n.map(e=>({id:e.id,detail:e.description,receiptNo:e.receipt_no||e.bill_no||"",amount:e.amount,date:e.date,method:e.payment_method||"Nakit",category:e.category}))}},O=async e=>{if(!e.customer_id)throw Error("M\xfcşteri se\xe7ilmeli");let t={...e,amount:Number(e.amount)},{error:r}=await a.from("collections").insert([t]);if(r)throw console.error("Create Col Error:",r),r;return!0},C=async(e,t)=>{let{error:r}=await a.from("collections").update(t).eq("id",e);if(r)throw r;return!0},E=async e=>{let{error:t}=await a.from("collections").delete().eq("id",e);if(t)throw t;return!0},N=async e=>{let{error:t}=await a.from("expenses").insert([e]);if(t)throw t;return!0},Y=async(e,t)=>{let{error:r}=await a.from("expenses").update(t).eq("id",e);if(r)throw r;return!0},j=async e=>{let{error:t}=await a.from("expenses").delete().eq("id",e);if(t)throw t;return!0},B=async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"thisMonth",t=arguments.length>1?arguments[1]:void 0,r=t.start,n=t.end;if("thisMonth"===e){let e=new Date;r=new Date(e.getFullYear(),e.getMonth(),1).toISOString().split("T")[0],n=new Date(e.getFullYear(),e.getMonth()+1,0).toISOString().split("T")[0]}else"allTime"===e&&(r="2020-01-01",n="2099-12-31");let{data:o}=await a.from("collections").select("amount").gte("date",r).lte("date",n),{data:i}=await a.from("expenses").select("amount").gte("date",r).lte("date",n),l=(o||[]).reduce((e,t)=>e+(t.amount||0),0),s=(i||[]).reduce((e,t)=>e+(t.amount||0),0);return{income:l,expense:s,balance:l-s}},z=async()=>{let{data:e,error:t}=await a.from("profiles").select("*").order("full_name");if(t)throw console.error("Error fetching profiles:",t),t;return e},A=e=>{switch(e){case"Y\xf6netici":return"sistem y\xf6neticisi";case"Sekreter":return"sekreter";case"Saha Sorumlusu":return"saha sorumlusu";case"Şof\xf6r":return"şof\xf6r";case"Veri Girici":return"veri girici";default:return null==e?void 0:e.toLowerCase()}},F=async e=>{let{data:t,error:r}=await a.from("profiles").insert([{full_name:e.name,email:e.email,role:A(e.role),phone:e.phone,status:"active"}]).select().single();if(r)throw r;return t},R=async(e,t)=>{let{data:r,error:n}=await a.from("profiles").update({full_name:t.name,email:t.email,role:A(t.role),phone:t.phone}).eq("id",e).select().single();if(n)throw n;return r},J=async e=>{let{error:t}=await a.from("profiles").delete().eq("id",e);if(t)throw t;return!0}}}]);